<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>越王勾践 | King Goujian</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bronze: #c5a059;
            --dark: #050505;
            --ink: #1a1a1a;
            --paper: #f0f0f0;
            --rust: #8C5E58;
            --active-color: #d4af37;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--dark);
            color: var(--paper);
            font-family: "Noto Serif SC", serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: none; /* Custom cursor */
        }

        /* Canvas Layer */
        #flow-field {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            opacity: 0.8;
            filter: url(#ink-wash);
            transition: opacity 1s ease;
        }

        /* Noise Texture Overlay */
        .noise {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            opacity: 0.08;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* Content Layer */
        .container {
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* Let clicks pass through to canvas/action */
        }

        /* Title Group */
        .title-group {
            position: absolute;
            right: 15%;
            top: 50%;
            transform: translateY(-50%);
            text-align: right;
            writing-mode: vertical-rl;
            text-orientation: upright;
            mix-blend-mode: difference;
            transition: all 1s ease;
        }

        h1 {
            font-size: 8vw;
            margin: 0;
            line-height: 1;
            font-weight: 900;
            letter-spacing: -0.05em;
            color: var(--bronze);
            filter: url(#text-distortion);
            opacity: 0;
            animation: revealTitle 2s cubic-bezier(0.77, 0, 0.175, 1) forwards 0.5s;
        }

        .subtitle {
            font-size: 1rem;
            letter-spacing: 0.5em;
            margin-right: 2rem;
            color: var(--paper);
            opacity: 0;
            animation: fadeUp 1.5s ease-out forwards 1.5s;
        }

        /* Seal / Action Button */
        #action-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            pointer-events: auto;
            cursor: none; /* We use custom cursor */
            z-index: 20;
            transition: all 1s cubic-bezier(0.22, 1, 0.36, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .seal-body {
            width: 100%;
            height: 100%;
            border: 2px solid var(--bronze);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bronze);
            font-size: 1.5rem;
            font-weight: bold;
            background: rgba(5, 5, 5, 0.6);
            backdrop-filter: blur(5px);
            transition: all 0.5s ease;
            box-shadow: 0 0 30px rgba(197, 160, 89, 0.1);
        }

        #action-container:hover .seal-body {
            background: var(--bronze);
            color: var(--dark);
            transform: scale(1.1);
            box-shadow: 0 0 50px rgba(197, 160, 89, 0.4);
        }

        /* Active State Styles */
        body.status-active #action-container {
            left: 60px;
            bottom: 60px;
            top: auto;
            transform: none;
            width: 60px;
            height: 60px;
        }
        
        body.status-active .seal-body {
            font-size: 0.9rem;
            border-color: var(--rust);
            color: var(--rust);
        }

        body.status-active .title-group {
            opacity: 0.3;
            filter: blur(2px);
            right: 5%;
        }

        /* Subtitles */
        #subtitle-container {
            position: absolute;
            left: 10%;
            top: 40%;
            width: 50%;
            z-index: 20;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            text-align: left;
        }

        body.status-active #subtitle-container {
            opacity: 1;
        }

        .speaker-label {
            font-size: 0.9rem;
            color: var(--bronze);
            margin-bottom: 1rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            display: block;
            font-weight: bold;
        }

        .subtitle-line {
            font-size: 1.8rem;
            line-height: 1.6;
            color: var(--paper);
            font-weight: 500;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* Char Animation */
        .char-span {
            display: inline-block;
            opacity: 0;
            transform: translateY(10px);
            filter: blur(5px);
            animation: ink-reveal 0.5s forwards;
        }

        @keyframes ink-reveal {
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        /* Custom Cursor */
        .cursor {
            position: fixed;
            top: 0;
            left: 0;
            width: 20px;
            height: 20px;
            border: 2px solid var(--bronze);
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
            mix-blend-mode: difference;
        }

        .cursor-trail {
            position: fixed;
            top: 0;
            left: 0;
            width: 8px;
            height: 8px;
            background: var(--bronze);
            border-radius: 50%;
            pointer-events: none;
            z-index: 99;
            transform: translate(-50%, -50%);
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        /* Animations */
        @keyframes revealTitle {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeUp {
            to { opacity: 0.8; transform: translateY(0); }
        }

        .svg-filters {
            position: absolute;
            width: 0;
            height: 0;
            pointer-events: none;
        }

    </style>
</head>
<body>

    <!-- SVG Filters -->
    <svg class="svg-filters">
        <defs>
            <filter id="ink-wash">
                <feTurbulence type="fractalNoise" baseFrequency="0.01 0.04" numOctaves="3" result="noise" />
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="20" xChannelSelector="R" yChannelSelector="G" />
                <feGaussianBlur stdDeviation="0.5" />
            </filter>
            <filter id="text-distortion">
                <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="2" result="turbulence" />
                <feDisplacementMap in="SourceGraphic" in2="turbulence" scale="5" xChannelSelector="R" yChannelSelector="G" />
            </filter>
        </defs>
    </svg>

    <div class="noise"></div>
    <canvas id="flow-field"></canvas>

    <div class="container">
        <div class="title-group">
            <div class="subtitle">The Sword of Goujian</div>
            <h1>越王勾践</h1>
        </div>
        
        <div id="subtitle-container">
            <div id="subtitle-content"></div>
        </div>

        <div id="action-container">
            <div class="seal-body">叩问</div>
        </div>
    </div>

    <div class="cursor"></div>
    <div class="cursor-trail"></div>

    <script>
        // ==========================================
        // Simplex Noise (Minimal)
        // ==========================================
        const SimplexNoise = (function() {
            function Grad(x, y, z) { this.x = x; this.y = y; this.z = z; }
            Grad.prototype.dot2 = function(x, y) { return this.x*x + this.y*y; };
            var grad3 = [new Grad(1,1,0),new Grad(-1,1,0),new Grad(1,-1,0),new Grad(-1,-1,0),
                         new Grad(1,0,1),new Grad(-1,0,1),new Grad(1,0,-1),new Grad(-1,0,-1),
                         new Grad(0,1,1),new Grad(0,-1,1),new Grad(0,1,-1),new Grad(0,-1,-1)];
            var p = [151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,
                     190, 6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,
                     125,136,171,168, 68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,
                     105,92,41,55,46,245,40,244,102,143,54, 65,25,63,161,1,216,80,73,209,76,132,187,208, 89,18,169,200,196,
                     135,130,116,188,159,86,164,100,109,198,173,186, 3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,
                     82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152, 2,44,154,163, 70,221,
                     153,101,155,167, 43,172,9,129,22,39,253, 19,98,108,110,79,113,224,232,178,185, 112,104,218,246,97,228,
                     251,34,242,193,238,210,144,12,191,179,162,241, 81,51,145,235,249,14,239,107,49,192,214, 31,181,199,106,
                     157,184, 84,204,176,115,121,50,45,127, 4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,
                     78,66,215,61,156,180];
            var perm = new Array(512);
            for(var i=0; i<512; i++) perm[i] = p[i & 255];
            function simplex2(xin, yin) {
                var n0, n1, n2; 
                var F2 = 0.5*(Math.sqrt(3.0)-1.0);
                var s = (xin+yin)*F2; 
                var i = Math.floor(xin+s);
                var j = Math.floor(yin+s);
                var G2 = (3.0-Math.sqrt(3.0))/6.0;
                var t = (i+j)*G2;
                var X0 = i-t; var Y0 = j-t;
                var i1, j1; 
                if(x0>y0) {i1=1; j1=0;} else {i1=0; j1=1;} 
                var x1 = x0 - i1 + G2; var y1 = y0 - j1 + G2;
                var x2 = x0 - 1.0 + 2.0 * G2; var y2 = y0 - 1.0 + 2.0 * G2;
                var ii = i & 255; var jj = j & 255;
                var gi0 = perm[ii+perm[jj]] % 12;
                var gi1 = perm[ii+i1+perm[jj+j1]] % 12;
                var gi2 = perm[ii+1+perm[jj+1]] % 12;
                var t0 = 0.5 - x0*x0 - y0*y0;
                if(t0<0) n0 = 0.0;
                else {t0 *= t0; n0 = t0 * t0 * grad3[gi0].dot2(x0, y0);}
                var t1 = 0.5 - x1*x1 - y1*y1;
                if(t1<0) n1 = 0.0;
                else {t1 *= t1; n1 = t1 * t1 * grad3[gi1].dot2(x1, y1);}
                var t2 = 0.5 - x2*x2 - y2*y2;
                if(t2<0) n2 = 0.0;
                else {t2 *= t2; n2 = t2 * t2 * grad3[gi2].dot2(x2, y2);}
                return 70.0 * (n0 + n1 + n2);
            }
            return { noise2D: simplex2 };
        })();

        // ==========================================
        // Logic & State
        // ==========================================
        let ws = null;
        let audioCtx = null;
        let mediaStream = null;
        let scriptProcessor = null;
        let analyser = null; 
        
        let nextPlayTime = 0;
        let currentSources = [];
        const SAMPLE_RATE_IN = 16000;
        const SAMPLE_RATE_OUT = 24000;

        const STATE = { IDLE: 'idle', CONNECTING: 'connecting', ACTIVE: 'active' };
        let currentState = STATE.IDLE;
        
        const actionContainer = document.getElementById('action-container');
        const sealBody = actionContainer.querySelector('.seal-body');
        const subtitleContent = document.getElementById('subtitle-content');

        // ==========================================
        // Visuals (Flow Field)
        // ==========================================
        const canvas = document.getElementById('flow-field');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        const particleCount = 800;
        let zOff = 0;
        let mouse = { x: -1000, y: -1000 };

        class Particle {
            constructor() {
                this.reset();
                this.x = Math.random() * width;
                this.y = Math.random() * height;
            }
            reset() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = 0; this.vy = 0;
                this.age = 0;
                this.lifeSpan = Math.random() * 200 + 50;
                this.color = Math.random() > 0.8 
                    ? `rgba(197, 160, 89, ${Math.random() * 0.5 + 0.1})` // Gold
                    : `rgba(20, 20, 20, ${Math.random() * 0.4 + 0.1})`;  // Ink
                this.width = Math.random() * 1.5 + 0.5;
            }
            update() {
                // Noise scale
                const scale = 0.003;
                const angle = SimplexNoise.noise2D(this.x * scale, this.y * scale + zOff) * Math.PI * 2;
                
                this.vx += Math.cos(angle) * 0.1;
                this.vy += Math.sin(angle) * 0.1;

                // Mouse repulsion
                const dx = this.x - mouse.x;
                const dy = this.y - mouse.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < 150) {
                    const force = (150 - dist) / 150;
                    this.vx += (dx/dist) * force * 1.5;
                    this.vy += (dy/dist) * force * 1.5;
                }

                this.x += this.vx;
                this.y += this.vy;
                this.vx *= 0.96; this.vy *= 0.96;

                if (this.x > width) this.x = 0;
                if (this.x < 0) this.x = width;
                if (this.y > height) this.y = 0;
                if (this.y < 0) this.y = height;

                this.age++;
                if (this.age > this.lifeSpan) this.reset();
            }
            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.width);
            }
        }

        function initVisuals() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            particles = [];
            for(let i=0; i<particleCount; i++) particles.push(new Particle());
            requestAnimationFrame(animateVisuals);
        }

        function animateVisuals() {
            // Trail effect
            ctx.fillStyle = 'rgba(5, 5, 5, 0.1)';
            ctx.fillRect(0, 0, width, height);

            zOff += 0.0005; // Time flow
            
            // Audio reactivity
            let audioEnergy = 0;
            if (analyser) {
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                // Average low freq energy
                audioEnergy = dataArray.slice(0, 20).reduce((a,b)=>a+b, 0) / 20;
            }

            particles.forEach(p => {
                if (currentState === STATE.ACTIVE && audioEnergy > 10) {
                    p.vx += (Math.random()-0.5) * (audioEnergy/50);
                    p.vy += (Math.random()-0.5) * (audioEnergy/50);
                }
                p.update();
                p.draw(ctx);
            });
            requestAnimationFrame(animateVisuals);
        }

        window.addEventListener('resize', () => {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        });
        window.addEventListener('mousemove', e => {
            mouse.x = e.clientX; mouse.y = e.clientY;
            // Custom cursor
            const cursor = document.querySelector('.cursor');
            const trail = document.querySelector('.cursor-trail');
            cursor.style.transform = `translate(${e.clientX}px, ${e.clientY}px) translate(-50%, -50%)`;
            setTimeout(() => trail.style.transform = `translate(${e.clientX}px, ${e.clientY}px) translate(-50%, -50%)`, 80);
        });

        initVisuals();

        // ==========================================
        // Subtitle & Logic
        // ==========================================
        class TypewriterQueue {
            constructor(container) {
                this.container = container;
                this.queue = [];
                this.isTyping = false;
                this.timer = null;
                this.currentSpeaker = "";
            }
            setSpeaker(speaker) {
                if(this.currentSpeaker !== speaker) {
                    this.currentSpeaker = speaker;
                    this.stopTyping();
                    this.queue = [];
                    this.container.innerHTML = `<span class="speaker-label">${speaker}</span><div class="subtitle-line"></div>`;
                }
            }
            pushText(text) {
                if(!text) return;
                if(!this.container.querySelector('.subtitle-line')) {
                    this.container.innerHTML = `<span class="speaker-label">${this.currentSpeaker}</span><div class="subtitle-line"></div>`;
                }
                for(let char of text) this.queue.push(char);
                if(!this.isTyping) this.startTyping();
            }
            stopTyping() {
                this.isTyping = false;
                if(this.timer) clearTimeout(this.timer);
                this.queue = [];
            }
            startTyping() {
                this.isTyping = true;
                this.processQueue();
            }
            processQueue() {
                if(this.queue.length === 0) { this.isTyping = false; return; }
                const char = this.queue.shift();
                const line = this.container.querySelector('.subtitle-line');
                if(line) {
                    const span = document.createElement('span');
                    span.textContent = char;
                    span.className = 'char-span';
                    line.appendChild(span);
                }
                let delay = 80;
                if(['，','。'].includes(char)) delay = 200;
                if(this.queue.length > 10) delay = 30;
                this.timer = setTimeout(() => this.processQueue(), delay);
            }
        }
        const subtitleQueue = new TypewriterQueue(subtitleContent);

        function setStatus(state) {
            currentState = state;
            document.body.className = `status-${state}`;
            if(state === STATE.IDLE) sealBody.innerText = "叩问";
            else if(state === STATE.CONNECTING) sealBody.innerText = "寻";
            else if(state === STATE.ACTIVE) sealBody.innerText = "断";
        }

        function showSubtitle(text, speaker, isAppend = false) {
            if(!isAppend || subtitleQueue.currentSpeaker !== speaker) {
                subtitleQueue.setSpeaker(speaker);
                subtitleQueue.stopTyping();
                subtitleQueue.container.innerHTML = `<span class="speaker-label">${speaker}</span><div class="subtitle-line"></div>`;
            }
            subtitleQueue.pushText(text);
        }

        // ==========================================
        // Interaction
        // ==========================================
        actionContainer.addEventListener('click', () => {
            if(currentState === STATE.ACTIVE) disconnect();
            else if(currentState === STATE.IDLE) connect();
            
            // Visual Burst
            for(let i=0; i<50; i++) {
                const p = new Particle();
                p.x = width/2; p.y = height/2;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2;
                p.vx = Math.cos(angle) * speed;
                p.vy = Math.sin(angle) * speed;
                p.color = '#c5a059';
                particles.push(p);
            }
        });

        // ==========================================
        // WebSocket & Audio
        // ==========================================
        function connect() {
            setStatus(STATE.CONNECTING);
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            ws = new WebSocket(wsUrl);
            ws.binaryType = 'arraybuffer';
            ws.onopen = () => console.log("WS Open");
            ws.onmessage = async (e) => {
                if(e.data instanceof ArrayBuffer) playAudioChunk(e.data);
                else handleMsg(JSON.parse(e.data));
            };
            ws.onclose = () => stopSession();
        }

        function handleMsg(msg) {
            switch(msg.type) {
                case "session_started": setStatus(STATE.ACTIVE); startRecording(); break;
                case "user_speaking": 
                    stopPlayback(); 
                    subtitleQueue.stopTyping();
                    showSubtitle("（倾听中...）", "你");
                    break;
                case "tts_start": if(msg.text) showSubtitle(msg.text, "越王勾践"); break;
                case "asr": if(msg.text) { showSubtitle(msg.text, "你"); } break;
                case "session_ended": stopSession(); break;
            }
        }

        function disconnect() {
            if(ws) { ws.send(JSON.stringify({action:"disconnect"})); ws.close(); }
            stopSession();
        }

        // Audio Logic (Simplified for brevity but functional)
        function playAudioChunk(data) {
            if(!audioCtx) return;
            const i16 = new Int16Array(data);
            const f32 = new Float32Array(i16.length);
            for(let i=0; i<i16.length; i++) f32[i] = i16[i]/0x7FFF;
            const buf = audioCtx.createBuffer(1, f32.length, SAMPLE_RATE_OUT);
            buf.getChannelData(0).set(f32);
            const src = audioCtx.createBufferSource();
            src.buffer = buf;
            if(!analyser) { analyser = audioCtx.createAnalyser(); analyser.fftSize = 512; }
            src.connect(analyser); analyser.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if(nextPlayTime < now) nextPlayTime = now;
            src.start(nextPlayTime);
            nextPlayTime += buf.duration;
            src.onended = () => { currentSources = currentSources.filter(s => s!==src); };
            currentSources.push(src);
        }

        function stopPlayback() {
            currentSources.forEach(s => { try{s.stop()}catch(e){} });
            currentSources = [];
            if(audioCtx) nextPlayTime = audioCtx.currentTime;
        }

        async function startRecording() {
            if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)({sampleRate: SAMPLE_RATE_OUT});
            if(audioCtx.state==='suspended') await audioCtx.resume();
            mediaStream = await navigator.mediaDevices.getUserMedia({audio:{channelCount:1}});
            const src = audioCtx.createMediaStreamSource(mediaStream);
            scriptProcessor = audioCtx.createScriptProcessor(4096, 1, 1);
            src.connect(scriptProcessor); scriptProcessor.connect(audioCtx.destination);
            scriptProcessor.onaudioprocess = e => {
                if(ws && ws.readyState===1) {
                    const input = e.inputBuffer.getChannelData(0);
                    // Downsample logic inline
                    const ratio = e.inputBuffer.sampleRate / SAMPLE_RATE_IN;
                    const len = Math.floor(input.length / ratio);
                    const res = new Int16Array(len);
                    for(let i=0; i<len; i++) {
                        const s = Math.max(-1, Math.min(1, input[Math.floor(i*ratio)]));
                        res[i] = s<0 ? s*0x8000 : s*0x7FFF;
                    }
                    ws.send(res.buffer);
                }
            };
        }

        function stopSession() {
            if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop());
            if(scriptProcessor) { scriptProcessor.disconnect(); scriptProcessor=null; }
            stopPlayback();
            if(ws) ws.close();
            setStatus(STATE.IDLE);
        }
    </script>
</body>
</html>
